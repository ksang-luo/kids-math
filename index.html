<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ« å…¨èƒ½æ•°å­¦æ€ç»´è®­ç»ƒæœº (è¯­éŸ³ç‰ˆ)</title>
    <style>
        :root {
            --primary: #FFB347;
            --secondary: #87CEEB;
            --accent: #FF6961;
            --success: #77DD77;
            --text: #444;
            --bg: #F0F4F8;
            --card-bg: #fff;
        }

        body {
            font-family: "Comic Sans MS", "Microsoft YaHei", "PingFang SC", sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(#dbe2e8 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        /* --- å¤´éƒ¨ --- */
        header {
            width: 100%;
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }
        h1 { margin: 0; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); font-size: 1.5rem; }

        .container {
            width: 95%;
            max-width: 600px;
            margin: 20px auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px;
        }

        /* --- å¡ç‰‡é€šç”¨ --- */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 2px solid white;
            animation: popIn 0.4s ease-out;
            position: relative;
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- å¹´çº§é€‰æ‹©å™¨ --- */
        .grade-tabs {
            display: flex;
            background: #fff;
            padding: 5px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            width: 100%;
            max-width: 400px;
        }
        .grade-tab {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            border-radius: 40px;
            cursor: pointer;
            font-weight: bold;
            color: #888;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .grade-tab.active {
            background: var(--secondary);
            color: white;
            box-shadow: 0 4px 10px rgba(135, 206, 235, 0.4);
        }

        /* --- é¢˜ç›®ç±»å‹æŒ‰é’® --- */
        .mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .mode-btn {
            border: none;
            padding: 15px 10px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .mode-btn:active { transform: scale(0.95); }
        .mode-btn span.desc { font-size: 0.75rem; font-weight: normal; opacity: 0.9; }

        .btn-blue { background: #54a0ff; box-shadow: 0 4px 0 #2e86de; }
        .btn-green { background: #1dd1a1; box-shadow: 0 4px 0 #10ac84; }
        .btn-orange { background: #ff9f43; box-shadow: 0 4px 0 #e58e26; }
        .btn-purple { background: #5f27cd; box-shadow: 0 4px 0 #341f97; }

        /* --- æ¸¸æˆåŒºåŸŸ --- */
        #gameArea { display: none; width: 100%; text-align: center; }
        
        .status-header {
            display: flex; justify-content: space-between; font-weight: bold; color: #888; margin-bottom: 15px; font-size: 0.9rem;
        }

        .question-wrapper {
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            background: #fafafa;
            border-radius: 15px;
            padding: 10px;
            position: relative; /* ä¸ºæœ—è¯»æŒ‰é’®å®šä½ */
        }

        .question-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            font-family: "Courier New", monospace;
            line-height: 1.2;
        }
        
        /* åº”ç”¨é¢˜ä¸“ç”¨æ ·å¼ */
        .word-problem {
            font-size: 1.3rem;
            font-family: "Microsoft YaHei", sans-serif;
            text-align: left;
            line-height: 1.6;
            color: #2c3e50;
        }

        /* æœ—è¯»é‡æ’­æŒ‰é’® */
        .replay-voice-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #eee;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            line-height: 30px;
            cursor: pointer;
            display: none; /* é»˜è®¤éšè—ï¼Œåº”ç”¨é¢˜æ˜¾ç¤º */
        }

        .method-hint {
            font-size: 0.95rem;
            color: #e67e22;
            margin-top: 10px;
            background: #fff3e0;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px dashed #e67e22;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .input-box {
            width: 140px; height: 50px;
            font-size: 1.8rem; text-align: center;
            border: 3px solid var(--secondary);
            border-radius: 10px; outline: none;
            background: #F0F8FF; color: #333;
            margin-bottom: 10px;
        }

        .numpad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
            max-width: 340px; margin: 0 auto;
        }
        .key {
            background: white; border: 1px solid #ddd;
            border-radius: 10px; padding: 12px;
            font-size: 1.3rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 #eee; color: #555;
            transition: background 0.1s;
        }
        .key:active { transform: translateY(2px); box-shadow: none; background: #f0f0f0; }
        .key.submit { background: var(--success); color: white; border-color: #5cbd5c; box-shadow: 0 3px 0 #4cae4c; }
        .key.back { background: var(--accent); color: white; border-color: #ff4d4d; box-shadow: 0 3px 0 #e60000; }

        .shake { animation: shake 0.4s; border-color: var(--accent); color: var(--accent); }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
        
        #feedback { height: 25px; margin-bottom: 5px; font-weight: bold; color: var(--success); font-size: 1.1rem; }

        .confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; overflow: hidden; display: none; }
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        /* é¡¶éƒ¨æŒ‰é’®ç»„ */
        .header-btn {
            position: absolute; top: 15px; 
            background: rgba(255,255,255,0.3); border: 2px solid white;
            color: white; padding: 5px 12px; border-radius: 20px;
            cursor: pointer; font-size: 0.9rem; font-weight: bold;
        }
        .back-btn { left: 15px; }
        .mute-btn { right: 15px; min-width: 30px;}
        
        .mistake-btn { width: 100%; background: #fff; color: var(--accent); border: 2px solid var(--accent); margin-top: 15px; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        .mistake-list { text-align: left; max-height: 400px; overflow-y: auto; padding: 0; list-style: none; }
        .mistake-item { background: #fff5f5; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid var(--accent); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mistake-content { font-size: 0.95rem; line-height: 1.5; width: 75%; }
        .del-mistake { background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

<header>
    <div class="header-btn back-btn" id="homeBtn" style="display:none" onclick="goHome()">ğŸ  é€€å‡º</div>
    <div class="header-btn mute-btn" id="muteBtn" onclick="toggleMute()">ğŸ”Š</div>
    <h1>ğŸ« å…¨èƒ½æ•°å­¦æ€ç»´è®­ç»ƒ</h1>
</header>

<div class="container">

    <!-- 1. å¹´çº§ä¸æ¨¡å¼é€‰æ‹© -->
    <div id="menuArea">
        <div class="grade-tabs">
            <div class="grade-tab active" onclick="switchGrade(1)">ä¸€å¹´çº§</div>
            <div class="grade-tab" onclick="switchGrade(2)">äºŒå¹´çº§</div>
            <div class="grade-tab" onclick="switchGrade(3)">ä¸‰å¹´çº§</div>
        </div>

        <div class="card">
            <h3 id="gradeTitle" style="text-align:center; color:#555; margin-bottom:20px;">ä¸€å¹´çº§ - é¢˜åº“é€‰æ‹©</h3>
            <div class="mode-grid" id="modeContainer">
                <!-- JS åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
            </div>
            <button class="mistake-btn" onclick="showMistakes()">ğŸ“• æŸ¥çœ‹æˆ‘çš„é”™é¢˜æœ¬</button>
        </div>
    </div>

    <!-- 2. ç­”é¢˜åŒºåŸŸ -->
    <div id="gameArea" class="card">
        <div class="status-header">
            <span id="gameModeTitle">æ¨¡å¼</span>
            <span id="scoreDisplay">âœ¨ å¾—åˆ†: 0</span>
        </div>

        <div class="question-wrapper">
            <div class="replay-voice-btn" id="replayVoiceBtn" onclick="readCurrentQuestion()">ğŸ”Š</div>
            <div id="questionText" class="question-text">10 + 5 = ?</div>
            <div id="methodHint" class="method-hint" style="display:none;"></div>
        </div>

        <div id="feedback"></div>
        
        <input type="text" id="answerInput" class="input-box" readonly placeholder="?">

        <div class="numpad">
            <button class="key" onclick="inputNum(1)">1</button>
            <button class="key" onclick="inputNum(2)">2</button>
            <button class="key" onclick="inputNum(3)">3</button>
            <button class="key" onclick="inputNum(4)">4</button>
            <button class="key" onclick="inputNum(5)">5</button>
            <button class="key" onclick="inputNum(6)">6</button>
            <button class="key" onclick="inputNum(7)">7</button>
            <button class="key" onclick="inputNum(8)">8</button>
            <button class="key" onclick="inputNum(9)">9</button>
            <button class="key back" onclick="inputNum('del')">ğŸ”™</button>
            <button class="key" onclick="inputNum(0)">0</button>
            <button class="key submit" onclick="submitAnswer()">ç¡®å®š</button>
        </div>
    </div>

    <!-- 3. é”™é¢˜æœ¬ -->
    <div id="mistakeArea" class="card" style="display:none;">
        <h3 style="color:var(--accent); text-align:center; margin-top:0;">ğŸ“• é”™é¢˜ç§¯ç´¯</h3>
        <p style="text-align:center; color:#999; font-size:0.8rem;">æ¸©æ•…è€ŒçŸ¥æ–°ï¼Œç‚¹å‡»å³ä¾§æŒ‰é’®ç§»é™¤</p>
        <ul class="mistake-list" id="mistakeList"></ul>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="mode-btn btn-blue" style="flex:1" onclick="goHome()">è¿”å›</button>
            <button class="mode-btn btn-orange" style="flex:1; background:#999; box-shadow:0 4px 0 #777;" onclick="clearAllMistakes()">æ¸…ç©º</button>
        </div>
    </div>

</div>

<!-- æ’’èŠ±ç‰¹æ•ˆå®¹å™¨ -->
<div id="confetti" class="confetti-container"></div>

<script>
    // --- ğŸ”Š éŸ³é¢‘ç®¡ç†å™¨ (æ–°å¢æ ¸å¿ƒåŠŸèƒ½) ---
    const AUDIO = {
        ctx: null, // AudioContext
        isMuted: false,
        synth: window.speechSynthesis,

        init: function() {
            if (!this.ctx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) this.ctx = new AudioContext();
            }
            if (this.ctx && this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },

        // æ’­æ”¾åˆæˆéŸ³æ•ˆ (ä¸éœ€è¦mp3æ–‡ä»¶)
        playTone: function(type) {
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);

            if (type === 'correct') {
                // å®å’šå£° (æ­£å¼¦æ³¢ï¼Œé«˜éŸ³)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.5);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.5);
            } else if (type === 'wrong') {
                // å—¡å—¡å£° (é”¯é½¿æ³¢ï¼Œä½éŸ³)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            }
        },

        // æ–‡æœ¬æœ—è¯» (TTS)
        speak: function(text) {
            if (this.isMuted) return;
            this.synth.cancel(); // åœæ­¢ä¸Šä¸€å¥
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-CN';
            utter.rate = 1.0; 
            utter.pitch = 1.1; // ç¨å¾®é«˜ä¸€ç‚¹çš„å£°éŸ³æ¯”è¾ƒäº²åˆ‡
            this.synth.speak(utter);
        },

        toggle: function() {
            this.isMuted = !this.isMuted;
            this.synth.cancel();
            const btn = document.getElementById('muteBtn');
            btn.innerText = this.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            btn.style.opacity = this.isMuted ? '0.5' : '1';
        }
    };


    // --- ğŸ’ è¯æ±‡å·¥å‚ (åº”ç”¨é¢˜ç”ŸæˆåŸæ–™) ---
    const VOCAB = {
        names: ['å°æ˜', 'å°çº¢', 'å°åˆš', 'ä¸½ä¸½', 'å¦ˆå¦ˆ', 'ç‹è€å¸ˆ', 'çˆ·çˆ·', 'å¥¶å¥¶', 'çˆ¸çˆ¸'],
        items_food: [['è‹¹æœ', 'ä¸ª'], ['æ©˜å­', 'ä¸ª'], ['ç³–æœ', 'é¢—'], ['é¥¼å¹²', 'åŒ…'], ['é¸¡è›‹', 'ä¸ª'], ['é¢åŒ…', 'ä¸ª']],
        items_stationery: [['é“…ç¬”', 'æ”¯'], ['æ©¡çš®', 'å—'], ['æ•…äº‹ä¹¦', 'æœ¬'], ['ä½œä¸šæœ¬', 'æœ¬'], ['å°ºå­', 'æŠŠ']],
        items_animal: [['å°é¸Ÿ', 'åª'], ['è´è¶', 'åª'], ['å°å…”å­', 'åª'], ['å°é¸­å­', 'åª'], ['å°æ¾é¼ ', 'åª']],
        items_toy: [['æ°”çƒ', 'ä¸ª'], ['çš®çƒ', 'ä¸ª'], ['ç§¯æœ¨', 'å—'], ['ç©å…·è½¦', 'è¾†'], ['å¸ƒå¨ƒå¨ƒ', 'ä¸ª']],
        acts_add: ['ä¹°æ¥äº†', 'åˆæ‘˜äº†', 'æ¡åˆ°äº†', 'æ”¶åˆ°äº†', 'åšå¥½äº†', 'åˆæ‹¿æ¥'],
        acts_sub: ['åƒæ‰äº†', 'é€äººäº†', 'å¼„ä¸¢äº†', 'ç”¨åäº†', 'é£èµ°äº†', 'å–æ‰äº†'],
    };

    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    // --- é¢˜åº“é…ç½® ---
    const GAME_CONFIG = {
        1: [
            { id: 'basic_20', name: '20ä»¥å†…åŠ å‡', color: 'btn-blue', desc: 'åŸºç¡€è®¡ç®—' },
            { id: 'method_10', name: 'å‡‘åæ³•/ç ´åæ³•', color: 'btn-orange', desc: 'è¿›ä½é€€ä½ä¸“é¡¹' },
            { id: 'word_easy', name: 'ç®€å•åº”ç”¨é¢˜', color: 'btn-green', desc: 'å¬é¢˜è§£é¢˜' }
        ],
        2: [
            { id: 'basic_100', name: '100ä»¥å†…åŠ å‡', color: 'btn-blue', desc: 'è¿›ä½é€€ä½' },
            { id: 'mul_table', name: 'ä¹˜æ³•å£è¯€', color: 'btn-orange', desc: 'ä¹ä¹ä¹˜æ³•è¡¨' },
            { id: 'word_mid', name: 'æ··åˆåº”ç”¨é¢˜', color: 'btn-green', desc: 'å¬é¢˜è§£é¢˜' }
        ],
        3: [
            { id: 'calc_hard', name: 'å¤šä½æ•°ä¹˜é™¤', color: 'btn-blue', desc: 'ç«–å¼è®¡ç®—åŸºç¡€' },
            { id: 'unit_calc', name: 'å·§ç®—é€Ÿç®—', color: 'btn-purple', desc: 'æ‰¾è§„å¾‹' },
            { id: 'word_hard', name: 'å¤æ‚åº”ç”¨é¢˜', color: 'btn-green', desc: 'é€»è¾‘æ€ç»´' }
        ]
    };

    // --- å…¨å±€å˜é‡ ---
    let currentGrade = 1;
    let currentMode = '';
    let currentQuestion = {};
    let score = 0;
    let mistakeBook = JSON.parse(localStorage.getItem('mathMistakes_final')) || [];

    // --- åˆå§‹åŒ– ---
    window.onload = () => switchGrade(1);

    function toggleMute() {
        AUDIO.init(); // ç¡®ä¿AudioContextå·²å¯åŠ¨
        AUDIO.toggle();
    }

    function switchGrade(grade) {
        currentGrade = grade;
        document.querySelectorAll('.grade-tab').forEach((t, i) => {
            t.classList.toggle('active', i + 1 === grade);
        });
        document.getElementById('gradeTitle').innerText = `${['ä¸€','äºŒ','ä¸‰'][grade-1]}å¹´çº§ - é¢˜åº“é€‰æ‹©`;
        renderModes();
    }

    function renderModes() {
        const container = document.getElementById('modeContainer');
        container.innerHTML = GAME_CONFIG[currentGrade].map(mode => `
            <button class="mode-btn ${mode.color}" onclick="startGame('${mode.id}', '${mode.name}')">
                <span>${mode.name}</span>
                <span class="desc">${mode.desc}</span>
            </button>
        `).join('');
    }

    // --- ğŸ­ æ™ºèƒ½åº”ç”¨é¢˜ç”Ÿæˆå¼•æ“ ---
    function generateWordProblem(grade) {
        let text = "", n1, n2, ans, op;
        const name = pick(VOCAB.names);
        
        if (grade === 1) {
            op = Math.random() > 0.5 ? '+' : '-';
            if (Math.random() > 0.5) {
                const [animal, unit] = pick(VOCAB.items_animal);
                n1 = rand(5, 15); n2 = rand(2, 9);
                if (op === '+') {
                    const verb = (animal === 'å°é¸Ÿ' || animal === 'è´è¶') ? 'é£æ¥äº†' : 'è·‘æ¥äº†';
                    text = `è‰åœ°ä¸ŠåŸæ¥æœ‰ ${n1} ${unit}${animal}ï¼Œåˆ${verb} ${n2} ${unit}ï¼Œç°åœ¨ä¸€å…±æœ‰å‡ ${unit}ï¼Ÿ`;
                    ans = n1 + n2;
                } else {
                    const verb = (animal === 'å°é¸Ÿ' || animal === 'è´è¶') ? 'é£èµ°äº†' : 'è·‘èµ°äº†';
                    text = `è‰åœ°ä¸Šæœ‰ ${n1} ${unit}${animal}ï¼Œ${verb} ${n2} ${unit}ï¼Œè¿˜å‰©å‡ ${unit}ï¼Ÿ`;
                    ans = n1 - n2;
                }
            } else {
                const [item, unit] = pick(VOCAB.items_food.concat(VOCAB.items_stationery));
                n1 = rand(5, 18); n2 = rand(1, n1 - 1); 
                if (op === '+') {
                    text = `${name}æœ‰ ${n1} ${unit}${item}ï¼Œå¦ˆå¦ˆåˆç»™äº†ä»– ${n2} ${unit}ï¼Œç°åœ¨ä»–æœ‰å‡ ${unit}ï¼Ÿ`;
                    ans = n1 + n2;
                } else {
                    const act = pick(VOCAB.acts_sub);
                    text = `${name}æœ‰ ${n1} ${unit}${item}ï¼Œ${act} ${n2} ${unit}ï¼Œè¿˜å‰©å‡ ${unit}ï¼Ÿ`;
                    ans = n1 - n2;
                }
            }
        } else if (grade === 2) {
            const type = Math.random();
            if (type < 0.4) {
                const [item, unit] = pick(VOCAB.items_food.concat(VOCAB.items_toy));
                n1 = rand(2, 9); n2 = rand(2, 9); op = '*';
                text = `å•†åº—é‡Œä¸€ç§${item}å– ${n1} å…ƒï¼Œ${name}æƒ³ä¹° ${n2} ${unit}ï¼Œä¸€å…±éœ€è¦å¤šå°‘é’±ï¼Ÿ`;
                ans = n1 * n2;
            } else if (type < 0.7) {
                const [item, unit] = pick(VOCAB.items_toy);
                n2 = rand(10, 30); n1 = rand(5, 20); op = '+';
                text = `${name}æ”¶é›†äº† ${n2} ${unit}${item}ï¼Œå°åˆšæ”¶é›†çš„æ¯”ä»–å¤š ${n1} ${unit}ï¼Œå°åˆšæœ‰å‡ ${unit}ï¼Ÿ`;
                ans = n2 + n1;
            } else {
                const [item, unit] = pick(VOCAB.items_food);
                n2 = rand(2, 8); ans = rand(3, 9); n1 = n2 * ans; op = '/';
                text = `ç›˜å­é‡Œæœ‰ ${n1} ${unit}${item}ï¼Œå¹³å‡åˆ†ç»™ ${n2} ä¸ªå°æœ‹å‹ï¼Œæ¯äººèƒ½åˆ†åˆ°å‡ ${unit}ï¼Ÿ`;
            }
        } else {
            const type = Math.random();
            if (type < 0.3) {
                const total = rand(80, 200); read = rand(20, 60); op = '-';
                text = `ä¸€æœ¬æ•…äº‹ä¹¦ä¸€å…±æœ‰ ${total} é¡µï¼Œ${name}ç¬¬ä¸€å¤©çœ‹äº† ${read} é¡µï¼Œè¿˜å‰©å¤šå°‘é¡µæ²¡çœ‹ï¼Ÿ`;
                ans = total - read;
            } else if (type < 0.6) {
                n1 = rand(50, 200); n2 = rand(30, 100); op = '+';
                text = `å¦ˆå¦ˆä¹°ä¸Šè¡£èŠ±äº† ${n1} å…ƒï¼Œä¹°è£¤å­èŠ±äº† ${n2} å…ƒï¼Œå¦ˆå¦ˆä¸€å…±èŠ±äº†å¤šå°‘é’±ï¼Ÿ`;
                ans = n1 + n2;
            } else {
                const [item, unit] = pick(VOCAB.items_food);
                n2 = rand(4, 8); ans = rand(10, 30); n1 = n2 * ans; op = '/';
                text = `æœå›­é‡Œæ‘˜äº† ${n1} ${unit}${item}ï¼Œæ¯ ${n2} ${unit}è£…ä¸€ç®±ï¼Œå¯ä»¥è£…å¤šå°‘ç®±ï¼Ÿ`;
            }
        }
        return { text, ans, isWord: true };
    }

    // --- æ¸¸æˆé€»è¾‘ ---
    function startGame(modeId, modeName) {
        AUDIO.init(); // å°è¯•åˆå§‹åŒ–éŸ³é¢‘ç¯å¢ƒ
        currentMode = modeId;
        score = 0;
        document.getElementById('scoreDisplay').innerText = `âœ¨ å¾—åˆ†: 0`;
        document.getElementById('gameModeTitle').innerText = modeName;
        document.getElementById('menuArea').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('homeBtn').style.display = 'block';
        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('answerInput').value = '';
        document.getElementById('feedback').innerText = '';
        document.getElementById('methodHint').style.display = 'none';
        
        let q = {};
        
        if (currentMode.startsWith('word_')) {
            q = generateWordProblem(currentGrade);
        } else if (currentMode === 'method_10') {
            if (Math.random() > 0.5) {
                let n1 = rand(6, 9); let n2 = rand(11-n1, 9);
                q.ans = n1 + n2; q.text = `${n1} + ${n2} = ?`;
                q.hint = `ğŸ’¡ æç¤ºï¼šæŠŠ ${n2} åˆ†æˆ ${10-n1} å’Œ ${n2-(10-n1)}ï¼Œå‡‘æˆ10`;
            } else {
                let n1 = rand(11, 18); let n2 = rand(n1-9, 9);
                q.ans = n1 - n2; q.text = `${n1} - ${n2} = ?`;
                q.hint = `ğŸ’¡ æç¤ºï¼šå…ˆç®— 10 - ${n2} = ${10-n2}ï¼Œå†åŠ  ${n1-10}`;
            }
        } else {
            // æ™®é€šè®¡ç®—é€»è¾‘ä¿æŒä¸å˜
            if (currentGrade === 1) {
                let op = Math.random() > 0.5 ? '+' : '-';
                if (op === '+') {
                    let n1 = rand(1, 15); let n2 = rand(1, 20-n1);
                    q.text = `${n1} + ${n2} = ?`; q.ans = n1+n2;
                } else {
                    let n1 = rand(5, 20); let n2 = rand(1, n1);
                    q.text = `${n1} - ${n2} = ?`; q.ans = n1-n2;
                }
            } else if (currentGrade === 2) {
                if (currentMode === 'mul_table') {
                    let n1 = rand(2, 9); let n2 = rand(2, 9);
                    q.text = `${n1} Ã— ${n2} = ?`; q.ans = n1*n2;
                } else {
                    let op = Math.random() > 0.5 ? '+' : '-';
                    let n1 = rand(10, 90); let n2 = rand(5, 50);
                    if(op==='+') { q.text=`${n1} + ${n2} = ?`; q.ans=n1+n2; }
                    else { if(n1<n2)[n1,n2]=[n2,n1]; q.text=`${n1} - ${n2} = ?`; q.ans=n1-n2; }
                }
            } else {
                let op = ['+','-','Ã—','Ã·'][Math.floor(Math.random()*4)];
                if(op==='Ã—') {
                    let n1 = rand(11, 30); let n2 = rand(2, 6);
                    q.text = `${n1} Ã— ${n2} = ?`; q.ans = n1*n2;
                } else if (op==='Ã·') {
                    let ans = rand(5, 20); let n2 = rand(2, 8);
                    let n1 = ans*n2;
                    q.text = `${n1} Ã· ${n2} = ?`; q.ans = ans;
                } else {
                    let n1 = rand(100, 500); let n2 = rand(50, 300);
                    if(op==='-'){ if(n1<n2)[n1,n2]=[n2,n1]; q.ans=n1-n2; q.text=`${n1} - ${n2} = ?`;}
                    else { q.ans=n1+n2; q.text=`${n1} + ${n2} = ?`; }
                }
            }
        }

        currentQuestion = q;
        renderQuestion(q);
    }

    function renderQuestion(q) {
        const textBox = document.getElementById('questionText');
        const hintBox = document.getElementById('methodHint');
        const voiceBtn = document.getElementById('replayVoiceBtn');
        
        textBox.innerText = q.text;
        
        if (q.isWord) {
            textBox.className = 'question-text word-problem';
            voiceBtn.style.display = 'block'; // æ˜¾ç¤ºé‡æ’­æŒ‰é’®
            // å»¶è¿Ÿä¸€ç‚¹ç‚¹è¯»é¢˜ï¼Œä½“éªŒæ›´è‡ªç„¶
            setTimeout(() => readCurrentQuestion(), 300);
        } else {
            textBox.className = 'question-text';
            voiceBtn.style.display = 'none';
        }

        if (q.hint) {
            hintBox.innerText = q.hint;
            hintBox.style.display = 'inline-block';
        }
    }

    function readCurrentQuestion() {
        if(currentQuestion.isWord) {
            AUDIO.speak(currentQuestion.text);
        }
    }

    // --- äº¤äº’ä¸ç»“ç®— ---
    function inputNum(val) {
        // ç‚¹å‡»æŒ‰é”®æ—¶ï¼Œåˆå§‹åŒ–Audio Contextï¼ˆè§£å†³iOSæµè§ˆå™¨é™éŸ³ç­–ç•¥ï¼‰
        if(AUDIO.ctx && AUDIO.ctx.state === 'suspended') AUDIO.ctx.resume();

        const input = document.getElementById('answerInput');
        if (val === 'del') input.value = input.value.slice(0, -1);
        else if (input.value.length < 5) input.value += val;
    }

    function submitAnswer() {
        const input = document.getElementById('answerInput');
        const val = parseInt(input.value);
        if (isNaN(val)) return;

        if (val === currentQuestion.ans) {
            // --- ç­”å¯¹ ---
            score += 10;
            document.getElementById('scoreDisplay').innerText = `âœ¨ å¾—åˆ†: ${score}`;
            document.getElementById('feedback').innerText = "ğŸ‰ ç­”å¯¹äº†ï¼";
            
            // æ’­æ”¾éŸ³æ•ˆ
            AUDIO.playTone('correct');
            // éšæœºå¤¸å¥–
            const praise = ['ç­”å¯¹äº†', 'çœŸæ£’', 'å¤ªèªæ˜äº†', 'æ­£ç¡®'];
            setTimeout(() => AUDIO.speak(praise[Math.floor(Math.random()*praise.length)]), 100);

            showConfetti();
            setTimeout(nextQuestion, 1500); // ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´ç»™è¯­éŸ³æ’­æ”¾
        } else {
            // --- ç­”é”™ ---
            document.getElementById('feedback').innerText = "ğŸ˜… åŠ æ²¹å†ç®—ç®—";
            input.classList.add('shake');
            
            // æ’­æ”¾éŸ³æ•ˆ
            AUDIO.playTone('wrong');
            AUDIO.speak("ç­”é”™äº†ï¼Œå†è¯•ä¸€æ¬¡");

            saveMistake(currentQuestion, val);
            setTimeout(() => input.classList.remove('shake'), 400);
        }
    }

    // --- æ’’èŠ±ç‰¹æ•ˆ ---
    function showConfetti() {
        const container = document.getElementById('confetti');
        container.style.display = 'block';
        container.innerHTML = '';
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
        for (let i = 0; i < 40; i++) {
            const div = document.createElement('div');
            div.className = 'confetti';
            div.style.left = Math.random() * 100 + 'vw';
            div.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            div.style.animationDuration = (Math.random() * 1 + 0.5) + 's';
            container.appendChild(div);
        }
        setTimeout(() => container.style.display = 'none', 1500);
    }

    // --- é”™é¢˜æœ¬ ---
    function saveMistake(q, wrongAns) {
        const item = {
            title: q.text,
            wrong: wrongAns,
            right: q.ans,
            tag: currentGrade + "å¹´çº§"
        };
        if (!mistakeBook.some(m => m.title === item.title)) {
            mistakeBook.unshift(item);
            localStorage.setItem('mathMistakes_final', JSON.stringify(mistakeBook));
        }
    }

    function showMistakes() {
        document.getElementById('menuArea').style.display = 'none';
        document.getElementById('mistakeArea').style.display = 'block';
        document.getElementById('homeBtn').style.display = 'none';
        
        const list = document.getElementById('mistakeList');
        if(mistakeBook.length === 0) {
            list.innerHTML = "<p style='text-align:center;color:#999;margin-top:50px;'>ğŸ† çœŸæ£’ï¼Œè¿˜æ²¡æœ‰é”™é¢˜å“¦ï¼</p>";
        } else {
            list.innerHTML = mistakeBook.map((m, i) => `
                <li class="mistake-item">
                    <div class="mistake-content">
                        <div style="font-weight:bold; color:#333; margin-bottom:5px;">${m.title}</div>
                        <div style="font-size:0.85rem; color:#666">
                            æˆ‘çš„ç­”æ¡ˆ: <span style="text-decoration:line-through;color:#FF6961">${m.wrong}</span> 
                            æ­£ç¡®: <span style="color:#77DD77;font-weight:bold">${m.right}</span>
                            <span style="font-size:0.7rem; background:#eee; padding:2px 5px; border-radius:4px; margin-left:5px;">${m.tag}</span>
                        </div>
                    </div>
                    <button class="del-mistake" onclick="removeMistake(${i})">å­¦ä¼šäº†</button>
                </li>
            `).join('');
        }
    }

    function removeMistake(index) {
        mistakeBook.splice(index, 1);
        localStorage.setItem('mathMistakes_final', JSON.stringify(mistakeBook));
        showMistakes(); 
    }

    function clearAllMistakes() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é”™é¢˜è®°å½•å—ï¼Ÿ")) {
            mistakeBook = [];
            localStorage.setItem('mathMistakes_final', JSON.stringify(mistakeBook));
            showMistakes();
        }
    }

    function goHome() {
        // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„å£°éŸ³
        AUDIO.synth.cancel();
        document.getElementById('gameArea').style.display = 'none';
        document.getElementById('mistakeArea').style.display = 'none';
        document.getElementById('menuArea').style.display = 'block';
        document.getElementById('homeBtn').style.display = 'none';
    }

</script>
</body>
</html>
